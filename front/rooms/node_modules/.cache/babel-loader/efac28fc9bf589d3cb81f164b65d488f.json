{"ast":null,"code":"import { _ as _assert_this_initialized } from \"@swc/helpers/_/_assert_this_initialized\";\nimport { _ as _class_call_check } from \"@swc/helpers/_/_class_call_check\";\nimport { _ as _create_class } from \"@swc/helpers/_/_create_class\";\nimport { _ as _define_property } from \"@swc/helpers/_/_define_property\";\nimport { _ as _inherits } from \"@swc/helpers/_/_inherits\";\nimport { _ as _object_spread } from \"@swc/helpers/_/_object_spread\";\nimport { _ as _object_without_properties } from \"@swc/helpers/_/_object_without_properties\";\nimport { _ as _to_consumable_array } from \"@swc/helpers/_/_to_consumable_array\";\nimport { _ as _create_super } from \"@swc/helpers/_/_create_super\";\nimport * as React from \"react\";\nimport { classNames } from \"@vkontakte/vkjs\";\nimport { clamp } from \"../../helpers/math\";\nimport { withContext } from \"../../hoc/withContext\";\nimport { withPlatform } from \"../../hoc/withPlatform\";\nimport { withDOM } from \"../../lib/dom\";\nimport { getNavId } from \"../../lib/getNavId\";\nimport { Platform } from \"../../lib/platform\";\nimport { setTransformStyle } from \"../../lib/styles\";\nimport { transitionEvent } from \"../../lib/supportEvents\";\nimport { rubber } from \"../../lib/touch\";\nimport { warnOnce } from \"../../lib/warnOnce\";\nimport { ConfigProviderContext } from \"../ConfigProvider/ConfigProviderContext\";\nimport { FocusTrap } from \"../FocusTrap/FocusTrap\";\nimport { Touch } from \"../Touch/Touch\";\nimport TouchRootContext from \"../Touch/TouchContext\";\nimport { ModalRootContext } from \"./ModalRootContext\";\nimport { MODAL_PAGE_DEFAULT_PERCENT_HEIGHT } from \"./constants\";\nimport { ModalType } from \"./types\";\nimport { withModalManager } from \"./useModalManager\";\nvar warn = warnOnce(\"ModalRoot\");\nfunction numberInRange(number, range) {\n  if (!range) {\n    return false;\n  }\n  return number >= range[0] && number <= range[1];\n}\nfunction rangeTranslate(number) {\n  return clamp(number, 0, 98);\n}\nvar ModalRootTouchComponent = /*#__PURE__*/function (_React_Component) {\n  \"use strict\";\n\n  _inherits(ModalRootTouchComponent, _React_Component);\n  var _super = _create_super(ModalRootTouchComponent);\n  function ModalRootTouchComponent(props) {\n    _class_call_check(this, ModalRootTouchComponent);\n    var _this;\n    _this = _super.call(this, props);\n    _define_property(_assert_this_initialized(_this), \"documentScrolling\", false);\n    _define_property(_assert_this_initialized(_this), \"maskElementRef\", void 0);\n    _define_property(_assert_this_initialized(_this), \"viewportRef\", /*#__PURE__*/React.createRef());\n    _define_property(_assert_this_initialized(_this), \"maskAnimationFrame\", undefined);\n    _define_property(_assert_this_initialized(_this), \"modalRootContext\", void 0);\n    _define_property(_assert_this_initialized(_this), \"frameIds\", void 0);\n    _define_property(_assert_this_initialized(_this), \"restoreFocusTo\", undefined);\n    _define_property(_assert_this_initialized(_this), \"preventTouch\", function (event) {\n      if (!event) {\n        return false;\n      }\n      while (event.originalEvent) {\n        event = event.originalEvent;\n      }\n      if (event.preventDefault) {\n        event.preventDefault();\n      }\n      return false;\n    });\n    _define_property(_assert_this_initialized(_this), \"updateModalHeight\", function () {\n      var modalState = _this.props.getModalState(_this.props.activeModal);\n      if (modalState && modalState.type === ModalType.PAGE) {\n        if (_this.props.enteringModal) {\n          _this.waitTransitionFinish(modalState, function () {\n            requestAnimationFrame(function () {\n              return _this.checkPageContentHeight();\n            });\n          });\n        } else {\n          requestAnimationFrame(function () {\n            return _this.checkPageContentHeight();\n          });\n        }\n      }\n    });\n    _define_property(_assert_this_initialized(_this), \"onTouchMove\", function (e) {\n      if (_this.props.exitingModal) {\n        return;\n      }\n      var modalState = _this.props.getModalState(_this.props.activeModal);\n      if (!modalState) {\n        return;\n      }\n      if (modalState.type === ModalType.PAGE) {\n        return _this.onPageTouchMove(e, modalState);\n      }\n      if (modalState.type === ModalType.CARD) {\n        return _this.onCardTouchMove(e, modalState);\n      }\n    });\n    _define_property(_assert_this_initialized(_this), \"onTouchEnd\", function (e) {\n      var modalState = _this.props.getModalState(_this.props.activeModal);\n      if ((modalState === null || modalState === void 0 ? void 0 : modalState.type) === ModalType.PAGE) {\n        return _this.onPageTouchEnd(e, modalState);\n      }\n      if ((modalState === null || modalState === void 0 ? void 0 : modalState.type) === ModalType.CARD) {\n        return _this.onCardTouchEnd(e, modalState);\n      }\n    });\n    _define_property(_assert_this_initialized(_this), \"onScroll\", function (e) {\n      var _modalState_contentElement;\n      var activeModal = _this.props.activeModal;\n      var target = e.target;\n      if (!activeModal) {\n        return;\n      }\n      var modalState = _this.props.getModalState(activeModal);\n      if ((modalState === null || modalState === void 0 ? void 0 : modalState.type) === ModalType.PAGE && (modalState === null || modalState === void 0 ? void 0 : (_modalState_contentElement = modalState.contentElement) === null || _modalState_contentElement === void 0 ? void 0 : _modalState_contentElement.contains(target))) {\n        modalState.contentScrolled = true;\n        if (modalState.contentScrollStopTimeout) {\n          clearTimeout(modalState.contentScrollStopTimeout);\n        }\n        modalState.contentScrollStopTimeout = setTimeout(function () {\n          if (modalState.contentScrolled) {\n            modalState.contentScrolled = false;\n          }\n        }, 250);\n      }\n    });\n    _this.state = {\n      touchDown: false,\n      dragging: false,\n      modalOpenedLog: []\n    };\n    _this.maskElementRef = /*#__PURE__*/React.createRef();\n    _this.modalRootContext = {\n      updateModalHeight: _this.updateModalHeight,\n      registerModal: function (_param) {\n        var id = _param.id,\n          data = _object_without_properties(_param, [\"id\"]);\n        var _this_props_getModalState;\n        return Object.assign((_this_props_getModalState = _this.props.getModalState(id)) !== null && _this_props_getModalState !== void 0 ? _this_props_getModalState : {}, data);\n      },\n      onClose: function () {\n        return _this.props.onExit();\n      },\n      isInsideModal: true\n    };\n    _this.frameIds = {};\n    return _this;\n  }\n  _create_class(ModalRootTouchComponent, [{\n    key: \"timeout\",\n    get: function get() {\n      return this.props.platform === Platform.IOS ? 400 : 320;\n    }\n  }, {\n    key: \"document\",\n    get: function get() {\n      return this.props.document;\n    }\n  }, {\n    key: \"window\",\n    get: function get() {\n      return this.props.window;\n    }\n  }, {\n    key: \"getModals\",\n    value: function getModals() {\n      return React.Children.toArray(this.props.children);\n    }\n  }, {\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      var\n      // Отслеживаем изменение размеров viewport\n      _this_window;\n      (_this_window = this.window) === null || _this_window === void 0 ? void 0 : _this_window.addEventListener(\"resize\", this.updateModalHeight, false);\n    }\n  }, {\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      this.toggleDocumentScrolling(true);\n      this.window.removeEventListener(\"resize\", this.updateModalHeight, false);\n    }\n  }, {\n    key: \"componentDidUpdate\",\n    value: function componentDidUpdate(prevProps) {\n      var _this = this;\n      // transition phase 2: animate exiting modal\n      if (this.props.exitingModal && this.props.exitingModal !== prevProps.exitingModal) {\n        this.closeModal(this.props.exitingModal);\n      }\n      // transition phase 3: animate entering modal\n      if (this.props.enteringModal && this.props.enteringModal !== prevProps.enteringModal) {\n        var enteringModal = this.props.enteringModal;\n        var enteringState = this.props.getModalState(enteringModal);\n        this.props.onEnter();\n        this.waitTransitionFinish(enteringState, function () {\n          if (enteringState === null || enteringState === void 0 ? void 0 : enteringState.innerElement) {\n            enteringState.innerElement.style.transitionDelay = \"\";\n          }\n          _this.props.onEntered(enteringModal);\n        });\n        if (enteringState === null || enteringState === void 0 ? void 0 : enteringState.innerElement) {\n          enteringState.innerElement.style.transitionDelay = this.props.delayEnter ? \"\".concat(this.timeout, \"ms\") : \"\";\n          this.animateTranslate(enteringState, enteringState.translateY);\n          this.setMaskOpacity(enteringState, 1);\n        }\n      }\n      // focus restoration\n      if (this.props.activeModal && !prevProps.activeModal) {\n        this.restoreFocusTo = this.document.activeElement;\n      }\n      if (!this.props.activeModal && !this.props.exitingModal && this.restoreFocusTo) {\n        this.restoreFocusTo.focus();\n        this.restoreFocusTo = null;\n      }\n      this.toggleDocumentScrolling(!this.props.activeModal && !this.props.exitingModal);\n    }\n  }, {\n    /* Отключает скролл документа */key: \"toggleDocumentScrolling\",\n    value: function toggleDocumentScrolling(enabled) {\n      if (this.documentScrolling === enabled) {\n        return;\n      }\n      this.documentScrolling = enabled;\n      if (enabled) {\n        // восстанавливаем значение overscroll behavior\n        // eslint-disable-next-line no-restricted-properties\n        this.document.documentElement.classList.remove(\"vkui--disable-overscroll-behavior\");\n        // некоторые браузеры на странных вендорах типа Meizu не удаляют обработчик.\n        // https://github.com/VKCOM/VKUI/issues/444\n        this.window.removeEventListener(\"touchmove\", this.preventTouch, {\n          // @ts-expect-error: TS2769 В интерфейсе EventListenerOptions нет поля passive\n          passive: false\n        });\n      } else {\n        // отключаем нативный pull-to-refresh при открытом модальном окне\n        // чтобы он не срабатывал при закрытии модалки смахиванием вниз\n        // eslint-disable-next-line no-restricted-properties\n        this.document.documentElement.classList.add(\"vkui--disable-overscroll-behavior\");\n        this.window.addEventListener(\"touchmove\", this.preventTouch, {\n          passive: false\n        });\n      }\n    }\n  }, {\n    key: \"checkPageContentHeight\",\n    value: function checkPageContentHeight() {\n      var modalState = this.props.getModalState(this.props.activeModal);\n      if ((modalState === null || modalState === void 0 ? void 0 : modalState.type) === ModalType.PAGE && (modalState === null || modalState === void 0 ? void 0 : modalState.modalElement)) {\n        var prevModalState = _object_spread({}, modalState);\n        initPageModal(modalState);\n        var currentModalState = _object_spread({}, modalState);\n        var needAnimate = false;\n        if (prevModalState.expandable === currentModalState.expandable) {\n          if (prevModalState.translateYFrom !== currentModalState.translateYFrom) {\n            needAnimate = true;\n          }\n        } else {\n          needAnimate = true;\n        }\n        if (needAnimate) {\n          this.animateTranslate(modalState, modalState.translateY);\n        }\n      }\n    }\n  }, {\n    key: \"closeModal\",\n    value: function closeModal(id) {\n      var _this = this;\n      // Сбрасываем состояния, которые могут помешать закрытию модального окна\n      this.setState({\n        touchDown: false\n      });\n      var prevModalState = this.props.getModalState(id);\n      if (!prevModalState) {\n        id && warn(\"closeActiveModal: модальное окно (страница) \".concat(id, \" не существует\"), \"error\");\n        return;\n      }\n      if (!this.state.modalOpenedLog.length) {\n        this.setState(function (prevState) {\n          return {\n            modalOpenedLog: _to_consumable_array(prevState.modalOpenedLog).concat([id])\n          };\n        });\n      }\n      var nextModalState = this.props.getModalState(this.props.activeModal);\n      var nextIsPage = !!nextModalState && nextModalState.type === ModalType.PAGE;\n      var prevIsPage = !!prevModalState && prevModalState.type === ModalType.PAGE;\n      this.waitTransitionFinish(prevModalState, function () {\n        return _this.props.onExited(id);\n      });\n      var _prevModalState_translateY, _nextModalState_translateYFrom, _nextModalState_translateYFrom1;\n      var exitTranslate = prevIsPage && nextIsPage && ((_prevModalState_translateY = prevModalState.translateY) !== null && _prevModalState_translateY !== void 0 ? _prevModalState_translateY : 0) <= ((_nextModalState_translateYFrom = nextModalState === null || nextModalState === void 0 ? void 0 : nextModalState.translateYFrom) !== null && _nextModalState_translateYFrom !== void 0 ? _nextModalState_translateYFrom : 0) && !this.props.isBack ? ((_nextModalState_translateYFrom1 = nextModalState === null || nextModalState === void 0 ? void 0 : nextModalState.translateYFrom) !== null && _nextModalState_translateYFrom1 !== void 0 ? _nextModalState_translateYFrom1 : 0) + 10 : 100;\n      this.animateTranslate(prevModalState, exitTranslate);\n      if (!nextModalState) {\n        // NOTE: was only for clean exit\n        this.setMaskOpacity(prevModalState, 0);\n        this.setState({\n          modalOpenedLog: []\n        });\n        prevModalState.translateY = undefined;\n      } else if (nextModalState.id && !this.state.modalOpenedLog.includes(nextModalState.id)) {\n        nextModalState.translateY = undefined;\n        this.setState(function (prevState) {\n          return {\n            modalOpenedLog: _to_consumable_array(prevState.modalOpenedLog).concat([nextModalState.id])\n          };\n        });\n      }\n    }\n  }, {\n    key: \"onPageTouchMove\",\n    value: function onPageTouchMove(event, modalState) {\n      var _modalState_innerElement, _modalState_headerElement;\n      var shiftY = event.shiftY,\n        originalEvent = event.originalEvent;\n      var target = originalEvent.target;\n      if (!event.isY) {\n        var _this_viewportRef_current;\n        if ((_this_viewportRef_current = this.viewportRef.current) === null || _this_viewportRef_current === void 0 ? void 0 : _this_viewportRef_current.contains(target)) {\n          originalEvent.preventDefault();\n        }\n        return;\n      }\n      if (!((_modalState_innerElement = modalState.innerElement) === null || _modalState_innerElement === void 0 ? void 0 : _modalState_innerElement.contains(target))) {\n        return originalEvent.preventDefault();\n      }\n      originalEvent.stopPropagation();\n      var expandable = modalState.expandable,\n        contentScrolled = modalState.contentScrolled,\n        collapsed = modalState.collapsed,\n        expanded = modalState.expanded;\n      if (!this.state.touchDown) {\n        var _modalState_contentElement;\n        var _modalState_contentElement_scrollTop;\n        modalState.touchStartContentScrollTop = (_modalState_contentElement_scrollTop = (_modalState_contentElement = modalState.contentElement) === null || _modalState_contentElement === void 0 ? void 0 : _modalState_contentElement.scrollTop) !== null && _modalState_contentElement_scrollTop !== void 0 ? _modalState_contentElement_scrollTop : 0;\n        this.setState({\n          touchDown: true\n        });\n      }\n      if (contentScrolled) {\n        return;\n      }\n      if (modalState.touchMovePositive === null) {\n        modalState.touchMovePositive = shiftY > 0;\n      }\n      if (!modalState.expandable || collapsed || expanded && modalState.touchMovePositive && modalState.touchStartContentScrollTop === 0 || ((_modalState_headerElement = modalState.headerElement) === null || _modalState_headerElement === void 0 ? void 0 : _modalState_headerElement.contains(target))) {\n        originalEvent.preventDefault();\n        if (!expandable && shiftY < 0 || !this.window) {\n          return;\n        }\n        !this.state.dragging && this.setState({\n          dragging: true\n        });\n        var shiftYPercent = shiftY / this.window.innerHeight * 100;\n        var shiftYCurrent = rubber(shiftYPercent, 72, 0.8, this.props.platform !== Platform.IOS);\n        modalState.touchShiftYPercent = shiftYPercent;\n        var _modalState_translateY;\n        modalState.translateYCurrent = rangeTranslate(((_modalState_translateY = modalState.translateY) !== null && _modalState_translateY !== void 0 ? _modalState_translateY : 0) + shiftYCurrent);\n        this.animateTranslate(modalState, modalState.translateYCurrent);\n        this.setMaskOpacity(modalState);\n      }\n    }\n  }, {\n    key: \"onCardTouchMove\",\n    value: function onCardTouchMove(event, modalState) {\n      var _modalState_innerElement;\n      var originalEvent = event.originalEvent,\n        shiftY = event.shiftY;\n      var target = originalEvent.target;\n      if ((_modalState_innerElement = modalState.innerElement) === null || _modalState_innerElement === void 0 ? void 0 : _modalState_innerElement.contains(target)) {\n        if (!this.state.touchDown) {\n          this.setState({\n            touchDown: true,\n            dragging: true\n          });\n        }\n        var shiftYPercent = shiftY / modalState.innerElement.offsetHeight * 100;\n        var shiftYCurrent = rubber(shiftYPercent, 72, 1.2, this.props.platform !== Platform.IOS);\n        modalState.touchShiftYPercent = shiftYPercent;\n        var _modalState_translateY;\n        modalState.translateYCurrent = Math.max(0, ((_modalState_translateY = modalState.translateY) !== null && _modalState_translateY !== void 0 ? _modalState_translateY : 0) + shiftYCurrent);\n        this.animateTranslate(modalState, modalState.translateYCurrent);\n        this.setMaskOpacity(modalState);\n      }\n    }\n  }, {\n    key: \"onPageTouchEnd\",\n    value: function onPageTouchEnd(event, modalState) {\n      var _this = this;\n      var startY = event.startY,\n        shiftY = event.shiftY;\n      modalState.contentScrolled = false;\n      modalState.touchMovePositive = null;\n      var setStateCallback;\n      if (this.state.dragging && this.window) {\n        var shiftYEndPercent = (startY + shiftY) / this.window.innerHeight * 100;\n        var _modalState_translateYCurrent;\n        var translateY = (_modalState_translateYCurrent = modalState.translateYCurrent) !== null && _modalState_translateYCurrent !== void 0 ? _modalState_translateYCurrent : 0;\n        var _modalState_touchShiftYPercent;\n        var expectTranslateY = translateY / event.duration * 240 * 0.6 * (((_modalState_touchShiftYPercent = modalState.touchShiftYPercent) !== null && _modalState_touchShiftYPercent !== void 0 ? _modalState_touchShiftYPercent : 0) < 0 ? -1 : 1);\n        translateY = rangeTranslate(translateY + expectTranslateY);\n        if (modalState.settlingHeight !== 100) {\n          if (numberInRange(translateY, modalState.expandedRange)) {\n            var _modalState_expandedRange;\n            var _modalState_expandedRange_;\n            translateY = (_modalState_expandedRange_ = (_modalState_expandedRange = modalState.expandedRange) === null || _modalState_expandedRange === void 0 ? void 0 : _modalState_expandedRange[0]) !== null && _modalState_expandedRange_ !== void 0 ? _modalState_expandedRange_ : 0;\n          } else if (numberInRange(translateY, modalState.collapsedRange)) {\n            var _modalState_translateYFrom;\n            translateY = (_modalState_translateYFrom = modalState.translateYFrom) !== null && _modalState_translateYFrom !== void 0 ? _modalState_translateYFrom : 0;\n          } else if (numberInRange(translateY, modalState.hiddenRange)) {\n            translateY = 100;\n          } else {\n            var _modalState_translateYFrom1;\n            translateY = (_modalState_translateYFrom1 = modalState.translateYFrom) !== null && _modalState_translateYFrom1 !== void 0 ? _modalState_translateYFrom1 : 0;\n          }\n        } else {\n          if (numberInRange(translateY, [0, 25])) {\n            translateY = 0;\n          } else {\n            translateY = 100;\n          }\n        }\n        if (translateY !== 100 && shiftYEndPercent >= 75) {\n          translateY = 100;\n        }\n        modalState.translateY = translateY;\n        modalState.translateYCurrent = translateY;\n        modalState.collapsed = numberInRange(translateY, modalState.collapsedRange);\n        modalState.expanded = translateY === 0;\n        modalState.hidden = translateY === 100;\n        if (modalState.hidden) {\n          this.props.onExit();\n        }\n        setStateCallback = function () {\n          if (!modalState.hidden) {\n            _this.animateTranslate(modalState, modalState.translateY);\n          }\n          _this.setMaskOpacity(modalState);\n        };\n      }\n      this.setState({\n        touchDown: false,\n        dragging: false\n      }, setStateCallback);\n    }\n  }, {\n    key: \"onCardTouchEnd\",\n    value: function onCardTouchEnd(param, modalState) {\n      var duration = param.duration;\n      var _this = this;\n      var setStateCallback;\n      if (this.state.dragging) {\n        var _modalState_translateYCurrent;\n        var translateY = (_modalState_translateYCurrent = modalState.translateYCurrent) !== null && _modalState_translateYCurrent !== void 0 ? _modalState_translateYCurrent : 0;\n        var _modalState_touchShiftYPercent;\n        var expectTranslateY = translateY / duration * 240 * 0.6 * (((_modalState_touchShiftYPercent = modalState.touchShiftYPercent) !== null && _modalState_touchShiftYPercent !== void 0 ? _modalState_touchShiftYPercent : 0) < 0 ? -1 : 1);\n        translateY = Math.max(0, translateY + expectTranslateY);\n        if (translateY >= 30) {\n          translateY = 100;\n        } else {\n          translateY = 0;\n        }\n        modalState.translateY = translateY;\n        modalState.hidden = translateY === 100;\n        if (modalState.hidden) {\n          this.props.onExit();\n        }\n        setStateCallback = function () {\n          if (!modalState.hidden) {\n            _this.animateTranslate(modalState, modalState.translateY);\n          }\n          _this.setMaskOpacity(modalState);\n        };\n      }\n      this.setState({\n        touchDown: false,\n        dragging: false\n      }, setStateCallback);\n    }\n  }, {\n    key: \"waitTransitionFinish\",\n    value: function waitTransitionFinish(modalState, eventHandler) {\n      if (transitionEvent.supported) {\n        var _modalState_innerElement;\n        var onceHandler = function () {\n          var _modalState_innerElement;\n          modalState === null || modalState === void 0 ? void 0 : (_modalState_innerElement = modalState.innerElement) === null || _modalState_innerElement === void 0 ? void 0 : _modalState_innerElement.removeEventListener(transitionEvent.name, onceHandler);\n          eventHandler();\n        };\n        modalState === null || modalState === void 0 ? void 0 : (_modalState_innerElement = modalState.innerElement) === null || _modalState_innerElement === void 0 ? void 0 : _modalState_innerElement.addEventListener(transitionEvent.name, onceHandler);\n      } else {\n        setTimeout(eventHandler, this.timeout);\n      }\n    }\n  }, {\n    /**\n    * Анимирует сдвиг модалки\n    *\n    * @param {ModalsStateEntry} modalState\n    * @param {number} percent Процент сдвига: 0 – полностью открыта, 100 – полностью закрыта\n    */\n    key: \"animateTranslate\",\n    value: function animateTranslate(modalState, percent) {\n      var frameId = \"animateTranslateFrame\".concat(modalState.id);\n      cancelAnimationFrame(this.frameIds[frameId]);\n      this.frameIds[frameId] = requestAnimationFrame(function () {\n        setTransformStyle(modalState.innerElement, \"translate3d(0, \".concat(percent, \"%, 0)\"));\n      });\n    }\n  }, {\n    /* Устанавливает прозрачность для полупрозрачной подложки */key: \"setMaskOpacity\",\n    value: function setMaskOpacity(modalState) {\n      var forceOpacity = arguments.length > 1 && arguments[1] !== void 0 ? arguments[1] : null;\n      var _this = this;\n      var _this_props_history;\n      if (forceOpacity === null && ((_this_props_history = this.props.history) === null || _this_props_history === void 0 ? void 0 : _this_props_history[0]) !== modalState.id) {\n        return;\n      }\n      if (this.maskAnimationFrame) {\n        cancelAnimationFrame(this.maskAnimationFrame);\n      }\n      this.maskAnimationFrame = requestAnimationFrame(function () {\n        if (_this.maskElementRef.current) {\n          var _modalState_translateY = modalState.translateY,\n            translateY = _modalState_translateY === void 0 ? 0 : _modalState_translateY,\n            _modalState_translateYCurrent = modalState.translateYCurrent,\n            translateYCurrent = _modalState_translateYCurrent === void 0 ? 0 : _modalState_translateYCurrent;\n          var opacity = forceOpacity === null ? 1 - (translateYCurrent - translateY) / (100 - translateY) || 0 : forceOpacity;\n          _this.maskElementRef.current.style.opacity = clamp(opacity, 0, 100).toString();\n          _this.maskElementRef.current.style.transitionDelay = opacity && _this.props.delayEnter ? \"\".concat(_this.timeout, \"ms\") : \"\";\n        }\n      });\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this = this;\n      var _this_props_configProvider;\n      var _this_props = this.props,\n        activeModal = _this_props.activeModal,\n        exitingModal = _this_props.exitingModal,\n        enteringModal = _this_props.enteringModal;\n      var _this_state = this.state,\n        touchDown = _this_state.touchDown,\n        dragging = _this_state.dragging;\n      if (!activeModal && !exitingModal) {\n        return null;\n      }\n      return /*#__PURE__*/React.createElement(TouchRootContext.Provider, {\n        value: true\n      }, /*#__PURE__*/React.createElement(ModalRootContext.Provider, {\n        value: this.modalRootContext\n      }, /*#__PURE__*/React.createElement(Touch, {\n        className: classNames(\"vkuiModalRoot\", ((_this_props_configProvider = this.props.configProvider) === null || _this_props_configProvider === void 0 ? void 0 : _this_props_configProvider.hasCustomPanelHeaderAfter) && \"vkuiModalRoot--hasCustomPanelHeaderAfterSlot\", touchDown && classNames(\"vkuiModalRoot--touched\", \"vkuiInternalModalRoot--touched\"), !!(enteringModal || exitingModal) && classNames(\"vkuiModalRoot--switching\", \"vkuiInternalModalRoot--switching\")),\n        onMove: this.onTouchMove,\n        onEnd: this.onTouchEnd,\n        onScroll: this.onScroll\n      }, /*#__PURE__*/React.createElement(\"div\", {\n        className: \"vkuiModalRoot__mask\",\n        onClick: this.props.onExit,\n        ref: this.maskElementRef\n      }), /*#__PURE__*/React.createElement(\"div\", {\n        className: \"vkuiModalRoot__viewport\",\n        ref: this.viewportRef\n      }, this.getModals().map(function (Modal) {\n        var modalId = getNavId(Modal.props, warn);\n        var _modalState = _this.props.getModalState(modalId);\n        if (modalId !== activeModal && modalId !== exitingModal || !_modalState) {\n          return null;\n        }\n        var modalState = _object_spread({}, _modalState);\n        var isPage = modalState.type === ModalType.PAGE;\n        var key = \"modal-\".concat(modalId);\n        return /*#__PURE__*/React.createElement(FocusTrap, {\n          key: key,\n          getRootRef: function (e) {\n            var modalState = _this.props.getModalState(modalId);\n            if (modalState) {\n              modalState.modalElement = e;\n            }\n          },\n          onClose: _this.props.onExit,\n          timeout: _this.timeout,\n          className: classNames(\"vkuiModalRoot__modal\", dragging && \"vkuiInternalModalRoot__modal--dragging\", isPage && modalState.expandable && \"vkuiInternalModalRoot__modal--expandable\", isPage && modalState.collapsed && \"vkuiInternalModalRoot__modal--collapsed\"),\n          restoreFocus: false\n        }, Modal);\n      })))));\n    }\n  }]);\n  return ModalRootTouchComponent;\n}(React.Component);\nexport var ModalRootTouch = withContext(withPlatform(withDOM(withModalManager(initModal)(ModalRootTouchComponent))), ConfigProviderContext, \"configProvider\");\n/**\n * Инициализирует модалку перед анимацией открытия\n */\nfunction initModal(modalState) {\n  switch (modalState.type) {\n    case ModalType.PAGE:\n      modalState.settlingHeight = modalState.settlingHeight || MODAL_PAGE_DEFAULT_PERCENT_HEIGHT;\n      return initPageModal(modalState);\n    case ModalType.CARD:\n      return initCardModal(modalState);\n    default:\n      process.env.NODE_ENV === \"development\" && warn('initActiveModal: modalState.type=\"'.concat(modalState.type, '\" не поддерживается'), \"error\");\n  }\n}\nfunction initPageModal(modalState) {\n  var contentElement = modalState.contentElement,\n    bottomInset = modalState.bottomInset;\n  var contentElementHeight = (contentElement === null || contentElement === void 0 ? void 0 : contentElement.firstElementChild).scrollHeight;\n  var bottomInsetHeight = (bottomInset === null || bottomInset === void 0 ? void 0 : bottomInset.offsetHeight) || 0;\n  var contentHeight = contentElementHeight + bottomInsetHeight;\n  var prevTranslateY = modalState.translateY;\n  var _contentElement_clientHeight;\n  modalState.expandable = contentHeight > ((_contentElement_clientHeight = contentElement === null || contentElement === void 0 ? void 0 : contentElement.clientHeight) !== null && _contentElement_clientHeight !== void 0 ? _contentElement_clientHeight : 0) || modalState.settlingHeight === 100 || modalState.expanded;\n  var collapsed = false;\n  var expanded = false;\n  var translateYFrom;\n  var translateY;\n  var expandedRange;\n  var collapsedRange;\n  var hiddenRange;\n  var hasCollapsedState = Boolean(modalState.expandable && modalState.settlingHeight !== 100);\n  if (modalState.expandable) {\n    var _modalState_settlingHeight;\n    translateYFrom = 100 - ((_modalState_settlingHeight = modalState.settlingHeight) !== null && _modalState_settlingHeight !== void 0 ? _modalState_settlingHeight : 0);\n    var shiftHalf = translateYFrom / 2;\n    var visiblePart = 100 - translateYFrom;\n    expandedRange = [0, shiftHalf];\n    collapsedRange = hasCollapsedState ? [shiftHalf, translateYFrom + visiblePart / 4] : undefined;\n    hiddenRange = [translateYFrom + visiblePart / 4, 100];\n    collapsed = hasCollapsedState && translateYFrom > 0;\n    expanded = translateYFrom <= 0;\n    translateY = translateYFrom;\n  } else {\n    var _modalState_headerElement, _modalState_innerElement_parentElement, _modalState_innerElement;\n    var _modalState_headerElement_offsetHeight;\n    var headerHeight = (_modalState_headerElement_offsetHeight = (_modalState_headerElement = modalState.headerElement) === null || _modalState_headerElement === void 0 ? void 0 : _modalState_headerElement.offsetHeight) !== null && _modalState_headerElement_offsetHeight !== void 0 ? _modalState_headerElement_offsetHeight : 0;\n    var height = contentHeight + headerHeight;\n    var _modalState_innerElement_parentElement_offsetHeight;\n    translateYFrom = 100 - height / ((_modalState_innerElement_parentElement_offsetHeight = (_modalState_innerElement = modalState.innerElement) === null || _modalState_innerElement === void 0 ? void 0 : (_modalState_innerElement_parentElement = _modalState_innerElement.parentElement) === null || _modalState_innerElement_parentElement === void 0 ? void 0 : _modalState_innerElement_parentElement.offsetHeight) !== null && _modalState_innerElement_parentElement_offsetHeight !== void 0 ? _modalState_innerElement_parentElement_offsetHeight : 0) * 100;\n    translateY = translateYFrom;\n    expandedRange = [translateY, translateY + 25];\n    collapsedRange = undefined;\n    hiddenRange = [translateY + 25, translateY + 100];\n  }\n  // Если модалка может открываться на весь экран, и новый сдвиг больше предыдущего, то откроем её на весь экран\n  if (modalState.expandable && translateY > (prevTranslateY !== null && prevTranslateY !== void 0 ? prevTranslateY : 100) || modalState.settlingHeight === 100) {\n    translateY = 0;\n  }\n  // Если модалка уже раскрыта обновляем состояния\n  if (translateY === 0) {\n    expanded = true;\n    collapsed = false;\n  }\n  modalState.expandedRange = expandedRange;\n  modalState.collapsedRange = collapsedRange;\n  modalState.hiddenRange = hiddenRange;\n  modalState.translateY = translateY;\n  modalState.translateYFrom = translateYFrom;\n  modalState.collapsed = collapsed;\n  modalState.expanded = expanded;\n}\nfunction initCardModal(modalState) {\n  modalState.translateY = 0;\n}","map":{"version":3,"names":["React","classNames","clamp","withContext","withPlatform","withDOM","getNavId","Platform","setTransformStyle","transitionEvent","rubber","warnOnce","ConfigProviderContext","FocusTrap","Touch","TouchRootContext","ModalRootContext","MODAL_PAGE_DEFAULT_PERCENT_HEIGHT","ModalType","withModalManager","warn","numberInRange","number","range","rangeTranslate","ModalRootTouchComponent","_React_Component","props","_define_property","_assert_this_initialized","_this","createRef","undefined","event","originalEvent","preventDefault","modalState","getModalState","activeModal","type","PAGE","enteringModal","waitTransitionFinish","requestAnimationFrame","checkPageContentHeight","e","exitingModal","onPageTouchMove","CARD","onCardTouchMove","onPageTouchEnd","onCardTouchEnd","_modalState_contentElement","target","contentElement","contains","contentScrolled","contentScrollStopTimeout","clearTimeout","setTimeout","state","touchDown","dragging","modalOpenedLog","maskElementRef","modalRootContext","updateModalHeight","registerModal","_param","id","data","_object_without_properties","_this_props_getModalState","Object","assign","onClose","onExit","isInsideModal","frameIds","key","get","platform","IOS","document","window","getModals","Children","toArray","children","componentDidMount","_this_window","addEventListener","componentWillUnmount","toggleDocumentScrolling","removeEventListener","componentDidUpdate","prevProps","closeModal","enteringState","onEnter","innerElement","style","transitionDelay","onEntered","delayEnter","concat","timeout","animateTranslate","translateY","setMaskOpacity","restoreFocusTo","activeElement","focus","enabled","documentScrolling","documentElement","classList","remove","preventTouch","passive","add","modalElement","prevModalState","_object_spread","initPageModal","currentModalState","needAnimate","expandable","translateYFrom","setState","length","prevState","_to_consumable_array","nextModalState","nextIsPage","prevIsPage","onExited","_prevModalState_translateY","_nextModalState_translateYFrom","_nextModalState_translateYFrom1","exitTranslate","isBack","includes","_modalState_innerElement","_modalState_headerElement","shiftY","isY","_this_viewportRef_current","viewportRef","current","stopPropagation","collapsed","expanded","_modalState_contentElement_scrollTop","touchStartContentScrollTop","scrollTop","touchMovePositive","headerElement","shiftYPercent","innerHeight","shiftYCurrent","touchShiftYPercent","_modalState_translateY","translateYCurrent","offsetHeight","Math","max","startY","setStateCallback","shiftYEndPercent","_modalState_translateYCurrent","_modalState_touchShiftYPercent","expectTranslateY","duration","settlingHeight","expandedRange","_modalState_expandedRange","_modalState_expandedRange_","collapsedRange","_modalState_translateYFrom","hiddenRange","_modalState_translateYFrom1","hidden","param","eventHandler","supported","onceHandler","name","percent","frameId","cancelAnimationFrame","forceOpacity","arguments","_this_props_history","history","maskAnimationFrame","opacity","toString","render","_this_props_configProvider","_this_props","_this_state","createElement","Provider","value","className","configProvider","hasCustomPanelHeaderAfter","onMove","onTouchMove","onEnd","onTouchEnd","onScroll","onClick","ref","map","Modal","modalId","_modalState","isPage","getRootRef","restoreFocus","Component","ModalRootTouch","initModal","initCardModal","process","env","NODE_ENV","bottomInset","contentElementHeight","firstElementChild","scrollHeight","bottomInsetHeight","contentHeight","prevTranslateY","_contentElement_clientHeight","clientHeight","hasCollapsedState","Boolean","_modalState_settlingHeight","shiftHalf","visiblePart","_modalState_innerElement_parentElement","_modalState_headerElement_offsetHeight","headerHeight","height","_modalState_innerElement_parentElement_offsetHeight","parentElement"],"sources":["../../../src/components/ModalRoot/ModalRoot.tsx"],"sourcesContent":["import * as React from 'react';\nimport { classNames } from '@vkontakte/vkjs';\nimport { clamp } from '../../helpers/math';\nimport { withContext } from '../../hoc/withContext';\nimport { withPlatform } from '../../hoc/withPlatform';\nimport { DOMProps, withDOM } from '../../lib/dom';\nimport { getNavId } from '../../lib/getNavId';\nimport { Platform } from '../../lib/platform';\nimport { setTransformStyle } from '../../lib/styles';\nimport { transitionEvent } from '../../lib/supportEvents';\nimport { rubber } from '../../lib/touch';\nimport { warnOnce } from '../../lib/warnOnce';\nimport { ConfigProviderContext } from '../ConfigProvider/ConfigProviderContext';\nimport { FocusTrap } from '../FocusTrap/FocusTrap';\nimport { Touch, TouchEvent } from '../Touch/Touch';\nimport TouchRootContext from '../Touch/TouchContext';\nimport { ModalRootContext, ModalRootContextInterface } from './ModalRootContext';\nimport { MODAL_PAGE_DEFAULT_PERCENT_HEIGHT } from './constants';\nimport { ModalRootWithDOMProps, ModalsStateEntry, ModalType, TranslateRange } from './types';\nimport { ModalTransitionProps, withModalManager } from './useModalManager';\nimport styles from './ModalRoot.module.css';\n\nconst warn = warnOnce('ModalRoot');\n\nfunction numberInRange(number: number, range: TranslateRange | undefined) {\n  if (!range) {\n    return false;\n  }\n  return number >= range[0] && number <= range[1];\n}\n\nfunction rangeTranslate(number: number) {\n  return clamp(number, 0, 98);\n}\n\ninterface ModalRootState {\n  touchDown?: boolean;\n  dragging?: boolean;\n  modalOpenedLog: string[];\n}\n\nclass ModalRootTouchComponent extends React.Component<\n  ModalRootWithDOMProps & DOMProps & ModalTransitionProps,\n  ModalRootState\n> {\n  constructor(props: ModalRootWithDOMProps & ModalTransitionProps) {\n    super(props);\n    this.state = {\n      touchDown: false,\n      dragging: false,\n      modalOpenedLog: [],\n    };\n\n    this.maskElementRef = React.createRef();\n\n    this.modalRootContext = {\n      updateModalHeight: this.updateModalHeight,\n      registerModal: ({ id, ...data }) => Object.assign(this.props.getModalState(id) ?? {}, data),\n      onClose: () => this.props.onExit(),\n      isInsideModal: true,\n    };\n\n    this.frameIds = {};\n  }\n\n  private documentScrolling = false;\n  private readonly maskElementRef: React.RefObject<HTMLDivElement>;\n  private readonly viewportRef = React.createRef<HTMLDivElement>();\n  private maskAnimationFrame: number | undefined = undefined;\n  private readonly modalRootContext: ModalRootContextInterface;\n  private readonly frameIds: {\n    [index: string]: number;\n  };\n  private restoreFocusTo: HTMLElement | undefined | null = undefined;\n\n  get timeout(): number {\n    return this.props.platform === Platform.IOS ? 400 : 320;\n  }\n\n  get document(): Document {\n    return this.props.document as Document;\n  }\n\n  get window(): Window {\n    return this.props.window as Window;\n  }\n\n  getModals() {\n    return React.Children.toArray(this.props.children) as React.ReactElement[];\n  }\n\n  componentDidMount() {\n    // Отслеживаем изменение размеров viewport\n    this.window?.addEventListener('resize', this.updateModalHeight, false);\n  }\n\n  componentWillUnmount() {\n    this.toggleDocumentScrolling(true);\n    this.window.removeEventListener('resize', this.updateModalHeight, false);\n  }\n\n  componentDidUpdate(prevProps: ModalRootWithDOMProps & ModalTransitionProps) {\n    // transition phase 2: animate exiting modal\n    if (this.props.exitingModal && this.props.exitingModal !== prevProps.exitingModal) {\n      this.closeModal(this.props.exitingModal);\n    }\n\n    // transition phase 3: animate entering modal\n    if (this.props.enteringModal && this.props.enteringModal !== prevProps.enteringModal) {\n      const { enteringModal } = this.props;\n      const enteringState = this.props.getModalState(enteringModal);\n      this.props.onEnter();\n      this.waitTransitionFinish(enteringState, () => {\n        if (enteringState?.innerElement) {\n          enteringState.innerElement.style.transitionDelay = '';\n        }\n        this.props.onEntered(enteringModal);\n      });\n\n      if (enteringState?.innerElement) {\n        enteringState.innerElement.style.transitionDelay = this.props.delayEnter\n          ? `${this.timeout}ms`\n          : '';\n        this.animateTranslate(enteringState, enteringState.translateY);\n        this.setMaskOpacity(enteringState, 1);\n      }\n    }\n\n    // focus restoration\n    if (this.props.activeModal && !prevProps.activeModal) {\n      this.restoreFocusTo = this.document.activeElement as HTMLElement;\n    }\n    if (!this.props.activeModal && !this.props.exitingModal && this.restoreFocusTo) {\n      this.restoreFocusTo.focus();\n      this.restoreFocusTo = null;\n    }\n\n    this.toggleDocumentScrolling(!this.props.activeModal && !this.props.exitingModal);\n  }\n\n  /* Отключает скролл документа */\n  toggleDocumentScrolling(enabled: boolean) {\n    if (this.documentScrolling === enabled) {\n      return;\n    }\n    this.documentScrolling = enabled;\n\n    if (enabled) {\n      // восстанавливаем значение overscroll behavior\n      // eslint-disable-next-line no-restricted-properties\n      this.document.documentElement.classList.remove('vkui--disable-overscroll-behavior');\n\n      // некоторые браузеры на странных вендорах типа Meizu не удаляют обработчик.\n      // https://github.com/VKCOM/VKUI/issues/444\n      this.window.removeEventListener('touchmove', this.preventTouch, {\n        // @ts-expect-error: TS2769 В интерфейсе EventListenerOptions нет поля passive\n        passive: false,\n      });\n    } else {\n      // отключаем нативный pull-to-refresh при открытом модальном окне\n      // чтобы он не срабатывал при закрытии модалки смахиванием вниз\n      // eslint-disable-next-line no-restricted-properties\n      this.document.documentElement.classList.add('vkui--disable-overscroll-behavior');\n\n      this.window.addEventListener('touchmove', this.preventTouch, {\n        passive: false,\n      });\n    }\n  }\n\n  preventTouch = (event: any) => {\n    if (!event) {\n      return false;\n    }\n    while (event.originalEvent) {\n      event = event.originalEvent;\n    }\n    if (event.preventDefault) {\n      event.preventDefault();\n    }\n    return false;\n  };\n\n  checkPageContentHeight() {\n    const modalState = this.props.getModalState(this.props.activeModal);\n\n    if (modalState?.type === ModalType.PAGE && modalState?.modalElement) {\n      const prevModalState = { ...modalState };\n      initPageModal(modalState);\n      const currentModalState = { ...modalState };\n\n      let needAnimate = false;\n\n      if (prevModalState.expandable === currentModalState.expandable) {\n        if (prevModalState.translateYFrom !== currentModalState.translateYFrom) {\n          needAnimate = true;\n        }\n      } else {\n        needAnimate = true;\n      }\n\n      if (needAnimate) {\n        this.animateTranslate(modalState, modalState.translateY);\n      }\n    }\n  }\n\n  updateModalHeight = () => {\n    const modalState = this.props.getModalState(this.props.activeModal);\n\n    if (modalState && modalState.type === ModalType.PAGE) {\n      if (this.props.enteringModal) {\n        this.waitTransitionFinish(modalState, () => {\n          requestAnimationFrame(() => this.checkPageContentHeight());\n        });\n      } else {\n        requestAnimationFrame(() => this.checkPageContentHeight());\n      }\n    }\n  };\n\n  closeModal(id: string) {\n    // Сбрасываем состояния, которые могут помешать закрытию модального окна\n    this.setState({ touchDown: false });\n\n    const prevModalState = this.props.getModalState(id);\n\n    if (!prevModalState) {\n      id && warn(`closeActiveModal: модальное окно (страница) ${id} не существует`, 'error');\n      return;\n    }\n    if (!this.state.modalOpenedLog.length) {\n      this.setState((prevState) => ({\n        modalOpenedLog: [...prevState.modalOpenedLog, id],\n      }));\n    }\n    const nextModalState = this.props.getModalState(this.props.activeModal);\n    const nextIsPage = !!nextModalState && nextModalState.type === ModalType.PAGE;\n\n    const prevIsPage = !!prevModalState && prevModalState.type === ModalType.PAGE;\n    this.waitTransitionFinish(prevModalState, () => this.props.onExited(id));\n    const exitTranslate =\n      prevIsPage &&\n      nextIsPage &&\n      (prevModalState.translateY ?? 0) <= (nextModalState?.translateYFrom ?? 0) &&\n      !this.props.isBack\n        ? (nextModalState?.translateYFrom ?? 0) + 10\n        : 100;\n    this.animateTranslate(prevModalState, exitTranslate);\n\n    if (!nextModalState) {\n      // NOTE: was only for clean exit\n      this.setMaskOpacity(prevModalState, 0);\n      this.setState({ modalOpenedLog: [] });\n      prevModalState.translateY = undefined;\n    } else if (nextModalState.id && !this.state.modalOpenedLog.includes(nextModalState.id)) {\n      nextModalState.translateY = undefined;\n      this.setState((prevState) => ({\n        modalOpenedLog: [...prevState.modalOpenedLog, nextModalState.id!],\n      }));\n    }\n  }\n\n  onTouchMove = (e: TouchEvent) => {\n    if (this.props.exitingModal) {\n      return;\n    }\n    const modalState = this.props.getModalState(this.props.activeModal);\n    if (!modalState) {\n      return;\n    }\n\n    if (modalState.type === ModalType.PAGE) {\n      return this.onPageTouchMove(e, modalState);\n    }\n\n    if (modalState.type === ModalType.CARD) {\n      return this.onCardTouchMove(e, modalState);\n    }\n  };\n\n  onPageTouchMove(event: TouchEvent, modalState: ModalsStateEntry) {\n    const { shiftY, originalEvent } = event;\n    const target = originalEvent.target as HTMLElement;\n\n    if (!event.isY) {\n      if (this.viewportRef.current?.contains(target)) {\n        originalEvent.preventDefault();\n      }\n      return;\n    }\n\n    if (!modalState.innerElement?.contains(target)) {\n      return originalEvent.preventDefault();\n    }\n\n    originalEvent.stopPropagation();\n\n    const { expandable, contentScrolled, collapsed, expanded } = modalState;\n\n    if (!this.state.touchDown) {\n      modalState.touchStartContentScrollTop = modalState.contentElement?.scrollTop ?? 0;\n      this.setState({ touchDown: true });\n    }\n\n    if (contentScrolled) {\n      return;\n    }\n\n    if (modalState.touchMovePositive === null) {\n      modalState.touchMovePositive = shiftY > 0;\n    }\n\n    if (\n      !modalState.expandable ||\n      collapsed ||\n      (expanded && modalState.touchMovePositive && modalState.touchStartContentScrollTop === 0) ||\n      modalState.headerElement?.contains(target)\n    ) {\n      originalEvent.preventDefault();\n\n      if ((!expandable && shiftY < 0) || !this.window) {\n        return;\n      }\n\n      !this.state.dragging && this.setState({ dragging: true });\n\n      const shiftYPercent = (shiftY / this.window.innerHeight) * 100;\n      const shiftYCurrent = rubber(shiftYPercent, 72, 0.8, this.props.platform !== Platform.IOS);\n\n      modalState.touchShiftYPercent = shiftYPercent;\n      modalState.translateYCurrent = rangeTranslate((modalState.translateY ?? 0) + shiftYCurrent);\n\n      this.animateTranslate(modalState, modalState.translateYCurrent);\n      this.setMaskOpacity(modalState);\n    }\n  }\n\n  onCardTouchMove(event: TouchEvent, modalState: ModalsStateEntry) {\n    const { originalEvent, shiftY } = event;\n    const target = originalEvent.target as HTMLElement;\n    if (modalState.innerElement?.contains(target)) {\n      if (!this.state.touchDown) {\n        this.setState({ touchDown: true, dragging: true });\n      }\n\n      const shiftYPercent = (shiftY / modalState.innerElement.offsetHeight) * 100;\n      const shiftYCurrent = rubber(shiftYPercent, 72, 1.2, this.props.platform !== Platform.IOS);\n\n      modalState.touchShiftYPercent = shiftYPercent;\n      modalState.translateYCurrent = Math.max(0, (modalState.translateY ?? 0) + shiftYCurrent);\n\n      this.animateTranslate(modalState, modalState.translateYCurrent);\n      this.setMaskOpacity(modalState);\n    }\n  }\n\n  onTouchEnd = (e: TouchEvent) => {\n    const modalState = this.props.getModalState(this.props.activeModal);\n\n    if (modalState?.type === ModalType.PAGE) {\n      return this.onPageTouchEnd(e, modalState);\n    }\n\n    if (modalState?.type === ModalType.CARD) {\n      return this.onCardTouchEnd(e, modalState);\n    }\n  };\n\n  onPageTouchEnd(event: TouchEvent, modalState: ModalsStateEntry) {\n    const { startY, shiftY } = event;\n\n    modalState.contentScrolled = false;\n    modalState.touchMovePositive = null;\n\n    let setStateCallback;\n\n    if (this.state.dragging && this.window) {\n      const shiftYEndPercent = ((startY + shiftY) / this.window.innerHeight) * 100;\n\n      let translateY = modalState.translateYCurrent ?? 0;\n      const expectTranslateY =\n        (translateY / event.duration) *\n        240 *\n        0.6 *\n        ((modalState.touchShiftYPercent ?? 0) < 0 ? -1 : 1);\n      translateY = rangeTranslate(translateY + expectTranslateY);\n\n      if (modalState.settlingHeight !== 100) {\n        if (numberInRange(translateY, modalState.expandedRange)) {\n          translateY = modalState.expandedRange?.[0] ?? 0;\n        } else if (numberInRange(translateY, modalState.collapsedRange)) {\n          translateY = modalState.translateYFrom ?? 0;\n        } else if (numberInRange(translateY, modalState.hiddenRange)) {\n          translateY = 100;\n        } else {\n          translateY = modalState.translateYFrom ?? 0;\n        }\n      } else {\n        if (numberInRange(translateY, [0, 25])) {\n          translateY = 0;\n        } else {\n          translateY = 100;\n        }\n      }\n\n      if (translateY !== 100 && shiftYEndPercent >= 75) {\n        translateY = 100;\n      }\n\n      modalState.translateY = translateY;\n      modalState.translateYCurrent = translateY;\n      modalState.collapsed = numberInRange(translateY, modalState.collapsedRange);\n      modalState.expanded = translateY === 0;\n      modalState.hidden = translateY === 100;\n\n      if (modalState.hidden) {\n        this.props.onExit();\n      }\n\n      setStateCallback = () => {\n        if (!modalState.hidden) {\n          this.animateTranslate(modalState, modalState.translateY);\n        }\n\n        this.setMaskOpacity(modalState);\n      };\n    }\n\n    this.setState(\n      {\n        touchDown: false,\n        dragging: false,\n      },\n      setStateCallback,\n    );\n  }\n\n  onCardTouchEnd({ duration }: TouchEvent, modalState: ModalsStateEntry) {\n    let setStateCallback;\n\n    if (this.state.dragging) {\n      let translateY = modalState.translateYCurrent ?? 0;\n\n      const expectTranslateY =\n        (translateY / duration) * 240 * 0.6 * ((modalState.touchShiftYPercent ?? 0) < 0 ? -1 : 1);\n      translateY = Math.max(0, translateY + expectTranslateY);\n\n      if (translateY >= 30) {\n        translateY = 100;\n      } else {\n        translateY = 0;\n      }\n\n      modalState.translateY = translateY;\n      modalState.hidden = translateY === 100;\n\n      if (modalState.hidden) {\n        this.props.onExit();\n      }\n\n      setStateCallback = () => {\n        if (!modalState.hidden) {\n          this.animateTranslate(modalState, modalState.translateY);\n        }\n\n        this.setMaskOpacity(modalState);\n      };\n    }\n\n    this.setState(\n      {\n        touchDown: false,\n        dragging: false,\n      },\n      setStateCallback,\n    );\n  }\n\n  onScroll = (e: React.SyntheticEvent) => {\n    const activeModal = this.props.activeModal;\n\n    const target = e.target as HTMLElement;\n\n    if (!activeModal) {\n      return;\n    }\n    const modalState = this.props.getModalState(activeModal);\n    if (modalState?.type === ModalType.PAGE && modalState?.contentElement?.contains(target)) {\n      modalState.contentScrolled = true;\n\n      if (modalState.contentScrollStopTimeout) {\n        clearTimeout(modalState.contentScrollStopTimeout);\n      }\n\n      modalState.contentScrollStopTimeout = setTimeout(() => {\n        if (modalState.contentScrolled) {\n          modalState.contentScrolled = false;\n        }\n      }, 250);\n    }\n  };\n\n  waitTransitionFinish(modalState: ModalsStateEntry | undefined, eventHandler: () => void) {\n    if (transitionEvent.supported) {\n      const onceHandler = () => {\n        modalState?.innerElement?.removeEventListener(transitionEvent.name as string, onceHandler);\n        eventHandler();\n      };\n\n      modalState?.innerElement?.addEventListener(transitionEvent.name as string, onceHandler);\n    } else {\n      setTimeout(eventHandler, this.timeout);\n    }\n  }\n\n  /**\n   * Анимирует сдвиг модалки\n   *\n   * @param {ModalsStateEntry} modalState\n   * @param {number} percent Процент сдвига: 0 – полностью открыта, 100 – полностью закрыта\n   */\n  animateTranslate(modalState: ModalsStateEntry, percent: number | undefined) {\n    const frameId = `animateTranslateFrame${modalState.id}`;\n\n    cancelAnimationFrame(this.frameIds[frameId]);\n\n    this.frameIds[frameId] = requestAnimationFrame(() => {\n      setTransformStyle(modalState.innerElement, `translate3d(0, ${percent}%, 0)`);\n    });\n  }\n\n  /* Устанавливает прозрачность для полупрозрачной подложки */\n  setMaskOpacity(modalState: ModalsStateEntry, forceOpacity: number | null = null) {\n    if (forceOpacity === null && this.props.history?.[0] !== modalState.id) {\n      return;\n    }\n    if (this.maskAnimationFrame) {\n      cancelAnimationFrame(this.maskAnimationFrame);\n    }\n    this.maskAnimationFrame = requestAnimationFrame(() => {\n      if (this.maskElementRef.current) {\n        const { translateY = 0, translateYCurrent = 0 } = modalState;\n\n        const opacity =\n          forceOpacity === null\n            ? 1 - (translateYCurrent - translateY) / (100 - translateY) || 0\n            : forceOpacity;\n        this.maskElementRef.current.style.opacity = clamp(opacity, 0, 100).toString();\n        this.maskElementRef.current.style.transitionDelay =\n          opacity && this.props.delayEnter ? `${this.timeout}ms` : '';\n      }\n    });\n  }\n\n  render() {\n    const { activeModal, exitingModal, enteringModal } = this.props;\n    const { touchDown, dragging } = this.state;\n\n    if (!activeModal && !exitingModal) {\n      return null;\n    }\n\n    return (\n      <TouchRootContext.Provider value={true}>\n        <ModalRootContext.Provider value={this.modalRootContext}>\n          <Touch\n            className={classNames(\n              styles['ModalRoot'],\n              this.props.configProvider?.hasCustomPanelHeaderAfter &&\n                styles['ModalRoot--hasCustomPanelHeaderAfterSlot'],\n              touchDown &&\n                classNames(styles['ModalRoot--touched'], 'vkuiInternalModalRoot--touched'),\n              !!(enteringModal || exitingModal) &&\n                classNames(styles['ModalRoot--switching'], 'vkuiInternalModalRoot--switching'),\n            )}\n            onMove={this.onTouchMove}\n            onEnd={this.onTouchEnd}\n            onScroll={this.onScroll}\n          >\n            <div\n              className={styles['ModalRoot__mask']}\n              onClick={this.props.onExit}\n              ref={this.maskElementRef}\n            />\n            <div className={styles['ModalRoot__viewport']} ref={this.viewportRef}>\n              {this.getModals().map((Modal) => {\n                const modalId = getNavId(Modal.props, warn);\n                const _modalState = this.props.getModalState(modalId);\n                if ((modalId !== activeModal && modalId !== exitingModal) || !_modalState) {\n                  return null;\n                }\n                const modalState = { ..._modalState };\n\n                const isPage = modalState.type === ModalType.PAGE;\n                const key = `modal-${modalId}`;\n\n                return (\n                  <FocusTrap\n                    key={key}\n                    getRootRef={(e) => {\n                      const modalState = this.props.getModalState(modalId);\n                      if (modalState) {\n                        modalState.modalElement = e;\n                      }\n                    }}\n                    onClose={this.props.onExit}\n                    timeout={this.timeout}\n                    className={classNames(\n                      styles['ModalRoot__modal'],\n\n                      dragging && 'vkuiInternalModalRoot__modal--dragging',\n\n                      isPage && modalState.expandable && 'vkuiInternalModalRoot__modal--expandable',\n                      isPage && modalState.collapsed && 'vkuiInternalModalRoot__modal--collapsed',\n                    )}\n                    restoreFocus={false}\n                  >\n                    {Modal}\n                  </FocusTrap>\n                );\n              })}\n            </div>\n          </Touch>\n        </ModalRootContext.Provider>\n      </TouchRootContext.Provider>\n    );\n  }\n}\n\nexport const ModalRootTouch = withContext(\n  withPlatform(\n    withDOM<ModalRootWithDOMProps>(withModalManager(initModal)(ModalRootTouchComponent)),\n  ),\n  ConfigProviderContext,\n  'configProvider',\n);\n\n/**\n * Инициализирует модалку перед анимацией открытия\n */\nfunction initModal(modalState: ModalsStateEntry) {\n  switch (modalState.type) {\n    case ModalType.PAGE:\n      modalState.settlingHeight = modalState.settlingHeight || MODAL_PAGE_DEFAULT_PERCENT_HEIGHT;\n      return initPageModal(modalState);\n    case ModalType.CARD:\n      return initCardModal(modalState);\n    default:\n      process.env.NODE_ENV === 'development' &&\n        warn(`initActiveModal: modalState.type=\"${modalState.type}\" не поддерживается`, 'error');\n  }\n}\n\nfunction initPageModal(modalState: ModalsStateEntry) {\n  const { contentElement, bottomInset } = modalState;\n  const contentElementHeight = (contentElement?.firstElementChild as HTMLElement).scrollHeight;\n  const bottomInsetHeight = bottomInset?.offsetHeight || 0;\n  const contentHeight = contentElementHeight + bottomInsetHeight;\n  let prevTranslateY = modalState.translateY;\n\n  modalState.expandable =\n    contentHeight > (contentElement?.clientHeight ?? 0) ||\n    modalState.settlingHeight === 100 ||\n    modalState.expanded;\n\n  let collapsed = false;\n  let expanded = false;\n  let translateYFrom;\n  let translateY;\n  let expandedRange: TranslateRange;\n  let collapsedRange: TranslateRange | undefined;\n  let hiddenRange: TranslateRange;\n\n  const hasCollapsedState = Boolean(modalState.expandable && modalState.settlingHeight !== 100);\n  if (modalState.expandable) {\n    translateYFrom = 100 - (modalState.settlingHeight ?? 0);\n\n    const shiftHalf = translateYFrom / 2;\n    const visiblePart = 100 - translateYFrom;\n\n    expandedRange = [0, shiftHalf];\n    collapsedRange = hasCollapsedState ? [shiftHalf, translateYFrom + visiblePart / 4] : undefined;\n    hiddenRange = [translateYFrom + visiblePart / 4, 100];\n\n    collapsed = hasCollapsedState && translateYFrom > 0;\n    expanded = translateYFrom <= 0;\n    translateY = translateYFrom;\n  } else {\n    const headerHeight = modalState.headerElement?.offsetHeight ?? 0;\n    const height = contentHeight + headerHeight;\n\n    translateYFrom =\n      100 - (height / (modalState.innerElement?.parentElement?.offsetHeight ?? 0)) * 100;\n    translateY = translateYFrom;\n\n    expandedRange = [translateY, translateY + 25];\n    collapsedRange = undefined;\n    hiddenRange = [translateY + 25, translateY + 100];\n  }\n\n  // Если модалка может открываться на весь экран, и новый сдвиг больше предыдущего, то откроем её на весь экран\n  if (\n    (modalState.expandable && translateY > (prevTranslateY ?? 100)) ||\n    modalState.settlingHeight === 100\n  ) {\n    translateY = 0;\n  }\n\n  // Если модалка уже раскрыта обновляем состояния\n  if (translateY === 0) {\n    expanded = true;\n    collapsed = false;\n  }\n\n  modalState.expandedRange = expandedRange;\n  modalState.collapsedRange = collapsedRange;\n  modalState.hiddenRange = hiddenRange;\n  modalState.translateY = translateY;\n  modalState.translateYFrom = translateYFrom;\n  modalState.collapsed = collapsed;\n  modalState.expanded = expanded;\n}\n\nfunction initCardModal(modalState: ModalsStateEntry) {\n  modalState.translateY = 0;\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}