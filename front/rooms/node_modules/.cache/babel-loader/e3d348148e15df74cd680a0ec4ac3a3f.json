{"ast":null,"code":"import { getAccessToken, clearTheStorage, getFromStorage, getLaunchParams, getVkUserId, pushToStorage, createJoinCallLink } from \"../bridge/bridgeLib\";\nimport { VkStorageKeys } from \"../bridge/storageKeys\";\nimport { ServerApiUrl } from \"../config\";\nexport class RoomInfo {\n  constructor(id, name, avatar, members, channels) {\n    this.id = id;\n    this.name = name;\n    this.avatar = avatar;\n    this.members = members;\n    this.channels = channels;\n    this.isFavourite = false;\n  }\n\n  setFavourite(isFav) {\n    if (isFav === this.isFavourite) return;\n    this.isFavourite = isFav;\n\n    if (isFav) {\n      getFromStorage(VkStorageKeys.FavouriteRooms).then(favRooms => pushToStorage(VkStorageKeys.FavouriteRooms, favRooms + ',' + this.id));\n    } else {\n      getFromStorage(VkStorageKeys.FavouriteRooms).then(favRooms => pushToStorage(VkStorageKeys.FavouriteRooms, favRooms.replaceAll(this.id, \"\").replaceAll(\",,\", \"\")));\n    }\n  }\n\n}\n\nasync function requestServer(request, data) {\n  let response = undefined;\n  let authToken = window.location.search.slice(1);\n  await fetch(`${ServerApiUrl}/${request}`, {\n    method: \"post\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n      \"Authorization\": authToken\n    },\n    body: JSON.stringify(data)\n  }).then(data => data.json()).then(json => response = json).catch(error => {\n    console.error(error);\n    alert(error);\n  });\n  console.log(request, \" response:\\n\", response);\n  return response;\n}\n\nasync function requestServerFile(request, data) {\n  let response = undefined;\n  let authToken = window.location.search.slice(1);\n  await fetch(`${ServerApiUrl}/${request}`, {\n    method: \"post\",\n    headers: {\n      \"Authorization\": authToken\n    },\n    body: data\n  }).then(data => data.json()).then(json => response = json).catch(error => {\n    console.error(error);\n    alert(error);\n  });\n  console.log(request, \" response:\\n\", response);\n  return response;\n}\n\nexport async function getJoinedRoomInfos() {\n  let ids = await getFromStorage(VkStorageKeys.JoinedRooms);\n  ids = ids.split(',').filter(x => x !== '');\n  let rooms = [];\n  let response = await requestServer(\"rooms/get\", {\n    room_ids: ids\n  });\n  if (response.rooms) rooms = response.rooms.map(x => Object.assign(new RoomInfo(), x));\n  let favIds = (await getFromStorage(VkStorageKeys.FavouriteRooms)).split(',').filter(x => x !== '');\n\n  for (let room of rooms) {\n    if (favIds.includes(room.id)) {\n      room.isFavourite = true;\n    }\n  }\n\n  return rooms;\n}\nexport async function joinRoom(id) {\n  getFromStorage(VkStorageKeys.JoinedRooms).then(joinedRooms => pushToStorage(VkStorageKeys.JoinedRooms, joinedRooms + ',' + id));\n  let response = await requestServer(\"rooms/join\", {\n    room_id: id\n  });\n  return response.room;\n}\nexport async function createRoom(newRoom) {\n  console.log(\"server_api room\", newRoom);\n  newRoom.addMember((await getLaunchParams()).vk_user_id);\n  await fillJoinLinks(newRoom);\n  getFromStorage(VkStorageKeys.JoinedRooms).then(joinedRooms => pushToStorage(VkStorageKeys.JoinedRooms, joinedRooms + ',' + newRoom.id));\n  let response = await requestServer(\"rooms/create\", {\n    room_data: newRoom\n  });\n  return response.room;\n}\nexport async function deleteRoom(id) {\n  let response = await requestServer(\"rooms/delete\", {\n    room_id: id\n  });\n  return response.room;\n}\n\nasync function fillJoinLinks(room) {\n  console.log(\"filling in joinlinks\", room);\n\n  for (let index = 0; index < room.channels.length; index++) {\n    let element = room.channels[index];\n    if (!element.joinlink) await createJoinCallLink(x => element.joinlink = x);\n  }\n\n  console.log(\"room with links\", room);\n}\n\nexport async function editChannel(room) {\n  console.log(\"edit channel\", room);\n  let response = await requestServer(\"rooms/update\", {\n    room_data: room\n  });\n  return response.room;\n}\nexport async function uploadImage(imageData) {\n  let response = await requestServerFile(\"rooms/uploadImage\", imageData);\n  return response.response;\n}","map":{"version":3,"names":["getAccessToken","clearTheStorage","getFromStorage","getLaunchParams","getVkUserId","pushToStorage","createJoinCallLink","VkStorageKeys","ServerApiUrl","RoomInfo","constructor","id","name","avatar","members","channels","isFavourite","setFavourite","isFav","FavouriteRooms","then","favRooms","replaceAll","requestServer","request","data","response","undefined","authToken","window","location","search","slice","fetch","method","headers","body","JSON","stringify","json","catch","error","console","alert","log","requestServerFile","getJoinedRoomInfos","ids","JoinedRooms","split","filter","x","rooms","room_ids","map","Object","assign","favIds","room","includes","joinRoom","joinedRooms","room_id","createRoom","newRoom","addMember","vk_user_id","fillJoinLinks","room_data","deleteRoom","index","length","element","joinlink","editChannel","uploadImage","imageData"],"sources":["/Users/mirustal/Documents/project/rooms/front/rooms/src/serverApi/serverApi.js"],"sourcesContent":["import { getAccessToken, clearTheStorage, getFromStorage, getLaunchParams, getVkUserId, pushToStorage, createJoinCallLink } from \"../bridge/bridgeLib\";\nimport { VkStorageKeys } from \"../bridge/storageKeys\";\nimport { ServerApiUrl } from \"../config\";\n\nexport class RoomInfo {\n    constructor(id, name, avatar, members, channels) {\n        this.id = id;\n        this.name = name;\n        this.avatar = avatar;\n        this.members = members;\n        this.channels = channels;\n        this.isFavourite = false;\n    }\n\n    setFavourite(isFav) {\n        if (isFav === this.isFavourite) return\n\n        this.isFavourite = isFav;\n\n        if (isFav) {\n            getFromStorage(VkStorageKeys.FavouriteRooms).then(favRooms => pushToStorage(VkStorageKeys.FavouriteRooms, favRooms + ',' + this.id))\n        } else {\n            getFromStorage(VkStorageKeys.FavouriteRooms).then(favRooms => pushToStorage(VkStorageKeys.FavouriteRooms, favRooms.replaceAll(this.id, \"\").replaceAll(\",,\",\"\")))\n        }\n    }\n}\n\nasync function requestServer(request, data) {\n    let response = undefined;\n    let authToken = window.location.search.slice(1)\n    await fetch(`${ServerApiUrl}/${request}`, {\n        method: \"post\",\n        headers: {\n            \"Content-Type\": \"application/json\",\n            \"Authorization\": authToken\n        },\n        body: JSON.stringify(data)\n    })\n        .then(data => data.json())\n        .then((json) => response = json)\n        .catch(error => {\n            console.error(error);\n            alert(error)\n        })\n    console.log(request, \" response:\\n\", response)\n    return response;\n}\n\nasync function requestServerFile(request, data) {\n    let response = undefined;\n    let authToken = window.location.search.slice(1)\n    await fetch(`${ServerApiUrl}/${request}`, {\n        method: \"post\",\n        headers: {\n            \"Authorization\": authToken\n        },\n        body: data\n    })\n        .then(data => data.json())\n        .then((json) => response = json)\n        .catch(error => {\n            console.error(error);\n            alert(error)\n        })\n    console.log(request, \" response:\\n\", response)\n    return response;\n}\n\nexport async function getJoinedRoomInfos() {\n    let ids = await getFromStorage(VkStorageKeys.JoinedRooms);\n    ids = ids.split(',').filter(x => x !== '');\n\n    let rooms = [];\n    let response = await requestServer(\"rooms/get\", { room_ids: ids });\n    if (response.rooms) rooms = response.rooms.map(x => Object.assign(new RoomInfo, x));\n    let favIds = (await getFromStorage(VkStorageKeys.FavouriteRooms)).split(',').filter(x => x !== '');\n    for (let room of rooms) {\n        if (favIds.includes(room.id)) {\n            room.isFavourite = true;\n        }\n    }\n    return rooms;\n}\n\nexport async function joinRoom(id) {\n    getFromStorage(VkStorageKeys.JoinedRooms).then(joinedRooms => pushToStorage(VkStorageKeys.JoinedRooms, joinedRooms + ',' + id))\n    let response = await requestServer(\"rooms/join\", { room_id: id });\n    return response.room;\n}\n\nexport async function createRoom(newRoom) {\n    console.log(\"server_api room\", newRoom)\n    newRoom.addMember((await getLaunchParams()).vk_user_id)\n    await fillJoinLinks(newRoom)\n    \n    getFromStorage(VkStorageKeys.JoinedRooms).then(joinedRooms => pushToStorage(VkStorageKeys.JoinedRooms, joinedRooms + ',' + newRoom.id))\n    let response = await requestServer(\"rooms/create\", { room_data: newRoom });\n    return response.room;\n}\n\nexport async function deleteRoom(id) {\n    let response = await requestServer(\"rooms/delete\", { room_id: id });\n    return response.room;\n}\n\nasync function fillJoinLinks(room) {\n    console.log(\"filling in joinlinks\", room)\n    for (let index = 0; index < room.channels.length; index++) {\n        let element = room.channels[index];\n        if (!element.joinlink) await createJoinCallLink(x => element.joinlink = x)\n    }\n    console.log(\"room with links\", room)\n}\n\nexport async function editChannel(room) {\n    console.log(\"edit channel\", room)\n    \n    let response = await requestServer(\"rooms/update\", {room_data: room})\n    return response.room\n}\n\nexport async function uploadImage(imageData) {\n    let response = await requestServerFile(\"rooms/uploadImage\",  imageData)\n    return response.response\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}